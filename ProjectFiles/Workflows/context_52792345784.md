# M10 CI Failure Analysis

**Workflow Run:** https://github.com/m-cahill/tunix-rt/actions/runs/20421039454  
**Branch:** `m10-refactor`  
**Date:** 2025-12-22 03:42 UTC

---

## Executive Summary

The M10 refactor branch has **1 critical failure** blocking the merge:

- **mypy type errors** in `backend/tunix_rt_backend/services/datasets_export.py` (3 instances)

All other jobs passed:
- ✅ E2E tests (passed)
- ✅ Security scans (passed)  
- ✅ Ruff linting (passed)
- ✅ Ruff formatting (passed)

---

## Root Cause: Missing Type Parameters for dict Return Types

### Failure Details

**Affected Jobs:**
- `backend (3.11)` - FAILED at mypy step
- `backend (3.12)` - FAILED at mypy step

**Error Messages:**
```
tunix_rt_backend/services/datasets_export.py:72: error: Missing type parameters for generic type "dict"  [type-arg]
tunix_rt_backend/services/datasets_export.py:95: error: Missing type parameters for generic type "dict"  [type-arg]
tunix_rt_backend/services/datasets_export.py:128: error: Missing type parameters for generic type "dict"  [type-arg]

Found 3 errors in 1 file (checked 28 source files)
```

### Problematic Code

**File:** `backend/tunix_rt_backend/services/datasets_export.py`

**Three functions with incomplete type annotations:**

1. **Line 72:** `def _build_trace_record(trace: Trace, trace_payload: ReasoningTrace) -> dict:`
2. **Line 95:** `def _build_tunix_sft_record(trace: Trace, trace_payload: ReasoningTrace) -> dict:`
3. **Line 128:** `def _build_training_example_record(trace: Trace, trace_payload: ReasoningTrace) -> dict:`

### Why This Fails

Python's `dict` is a generic type that requires type parameters when used in type annotations with mypy strict mode:
- **Wrong:** `-> dict`  ❌
- **Correct:** `-> dict[str, Any]` ✅

The M10 refactor introduced these new service functions but didn't include the full type parameters required by mypy.

---

## Impact Assessment

**Severity:** HIGH - Blocks merge

**Jobs Affected:**
- Backend tests on Python 3.11: FAILED
- Backend tests on Python 3.12: FAILED

**Jobs Unaffected:**
- E2E tests: PASSED
- Security scans: PASSED
- Changes detection: PASSED
- Ruff linting/formatting: PASSED

**Why This Wasn't Caught Locally:**

The local development environment ran `ruff check` and `ruff format`, but the CI workflow specifically runs `mypy tunix_rt_backend` which enforces stricter type checking. This is intentional - mypy provides stronger type safety guarantees than ruff alone.

---

## Recommended Fix

### Change Required

Update three function signatures in `backend/tunix_rt_backend/services/datasets_export.py`:

**Before (lines 72, 95, 128):**
```python
def _build_trace_record(...) -> dict:
def _build_tunix_sft_record(...) -> dict:
def _build_training_example_record(...) -> dict:
```

**After:**
```python
from typing import Any

def _build_trace_record(...) -> dict[str, Any]:
def _build_tunix_sft_record(...) -> dict[str, Any]:
def _build_training_example_record(...) -> dict[str, Any]:
```

### Implementation Steps

1. Add `Any` to the imports at the top of `datasets_export.py`
   ```python
   from typing import Any  # Add to existing imports
   ```

2. Update three function return types:
   - Line 72: `-> dict:` → `-> dict[str, Any]:`
   - Line 95: `-> dict:` → `-> dict[str, Any]:`
   - Line 128: `-> dict:` → `-> dict[str, Any]:`

3. Run mypy locally to verify:
   ```bash
   cd backend
   mypy tunix_rt_backend
   ```

4. Expected output:
   ```
   Success: no issues found in 28 source files
   ```

5. Commit and push:
   ```bash
   git add backend/tunix_rt_backend/services/datasets_export.py
   git commit -m "fix(m10): add type parameters to dict return types"
   git push origin m10-refactor
   ```

---

## Prevention Strategy

**Why This Happened:**

During the M10 implementation, the service layer functions were created with return type `-> dict` which is valid Python but incomplete for mypy's strict type checking. The local pre-push flow didn't include running mypy before pushing.

**Recommended Guardrails:**

1. **Add mypy to pre-push checklist:**
   ```bash
   # Before pushing
   cd backend
   ruff check .
   ruff format --check .
   mypy tunix_rt_backend  # ← ADD THIS
   pytest
   ```

2. **Consider pre-commit hook:**
   Create `.git/hooks/pre-push` that runs mypy automatically

3. **Update M10_GUARDRAILS.md:**
   Add a section on type annotation best practices:
   - Always use `dict[K, V]` not `dict`
   - Always use `list[T]` not `list`
   - Import `Any` from `typing` when needed

---

## Testing Verification

After applying the fix, verify:

1. **Mypy passes locally:**
   ```bash
   cd backend
   mypy tunix_rt_backend
   # Expected: Success: no issues found in 28 source files
   ```

2. **All tests still pass:**
   ```bash
   pytest
   # Expected: 138 passed
   ```

3. **Formatting unchanged:**
   ```bash
   ruff format --check .
   # Expected: 48 files already formatted
   ```

4. **Push and verify CI:**
   - Wait for backend (3.11) and backend (3.12) jobs to go green

---

## Additional Context

**Changed Files in M10 (from logs):**
- ✅ `backend/tests/test_datasets.py` - modified
- ✅ `backend/tests/test_services.py` - added (NEW)
- ✅ `backend/tunix_rt_backend/app.py` - modified  
- ✅ `backend/tunix_rt_backend/schemas/__init__.py` - modified
- ✅ `backend/tunix_rt_backend/schemas/dataset.py` - modified
- ✅ `backend/tunix_rt_backend/services/__init__.py` - added (NEW)
- ❌ `backend/tunix_rt_backend/services/datasets_export.py` - added (NEW, has type errors)
- ✅ `backend/tunix_rt_backend/services/traces_batch.py` - added (NEW)
- ✅ `backend/tunix_rt_backend/training/schema.py` - modified
- ✅ `docs/M10_BASELINE.md` - added (NEW)
- ✅ `docs/M10_GUARDRAILS.md` - added (NEW)

**Only 1 file needs fixing:** `datasets_export.py`

---

## Summary

**Problem:** 3 functions missing type parameters in dict return types  
**Solution:** Add `-> dict[str, Any]` to 3 function signatures  
**Effort:** < 5 minutes  
**Risk:** Very low - purely type annotation change, no logic changes  

**Ready for fix:** ✅ Wait for confirmation before applying changes.
