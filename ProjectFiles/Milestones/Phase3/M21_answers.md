Here are **clear, decision-ready answers** to the M21 questions, optimized for **audit score lift**, **CI determinism**, and **minimal churn**. (Referencing the questions doc directly.) 

---

## 1ï¸âƒ£ Frontend Audit (`npm audit` + ENOLOCK)

### âœ… **Decision**

**Yes â€” regenerate `package-lock.json` before addressing audit failures.**

### ğŸ” Why

An `ENOLOCK` during `npm audit` means npm believes the lockfile is:

* missing,
* out of sync with `package.json`,
* or generated by a different npm major version in a way it canâ€™t reconcile.

Running audit *before* fixing this yields unreliable results and hurts reproducibility â€” which directly impacts audit scoring.

### ğŸ› ï¸ Canonical Fix (do this in order)

```bash
cd frontend
rm -rf node_modules
npm install --package-lock-only
npm audit
```

Then:

* Apply **targeted fixes** (preferred)
* Or add `"overrides"` for known esbuild/Vite issues
* Avoid `npm audit fix --force` unless explicitly justified

### ğŸ§± Guardrail (recommended)

* Commit the regenerated `package-lock.json`
* Ensure CI uses `npm ci` (not `npm install`)
* Optionally document the npm version used to generate the lockfile

**Audit impact:** High â€” eliminates false negatives and stabilizes dependency analysis.

---

## 2ï¸âƒ£ Phase 4.2 â€” Playwright Traces on First Failure

### âœ… **Decision**

**Yes â€” change Playwright `trace` to `retain-on-failure`.**

### ğŸ” Why

You already upload artifacts with `if: always()`, which is good â€” but with:

```ts
trace: 'on-first-retry'
```

you **lose all trace data if the test fails on the first attempt** (which is the most common CI failure mode).

That undermines the entire purpose of Phase 4.

### ğŸ› ï¸ Recommended Config

In `playwright.config.ts`:

```ts
use: {
  trace: 'retain-on-failure',
}
```

This gives you:

* Zero overhead on passing runs
* Full traces for *any* failure, including the first one
* Much higher signal in CI artifacts

**Audit impact:** Mediumâ€“High â€” directly improves observability and reliability scoring.

---

## 3ï¸âƒ£ Phase 5.1 â€” â€œPromote Best Trialâ€ Button Placement

### âœ… **Decision**

**Option A only** for M21.

> **A: A single â€œPromote Bestâ€ button in the Job List (actions column)**

### ğŸ” Why

* Matches **user intent**: â€œthis tuning job is done â†’ promote its best resultâ€
* Keeps UI minimal (important for audit scope)
* Avoids ambiguity about *which* trial is â€œbestâ€ â€” backend already knows
* Much easier to test and reason about

### âŒ Why not B or C (for now)

* **B (per-trial buttons)** introduces decision paralysis and UX complexity
* **C (both)** adds surface area without audit benefit
* Both require more tests and UI logic â†’ lower ROI for M21

### ğŸ§± Implementation Guidance

* Button appears when job status is `completed`
* Clicking:

  1. Resolves best trial/run server-side
  2. Calls promote endpoint
  3. Shows toast + refreshes registry view

You can always add per-trial promotion later (M22+), but **audit reviewers reward clarity over optionality**.

**Audit impact:** Medium â€” strong product maturity signal with low complexity.

---

## Summary Table (for Cursor)

| Question          | Decision                    | Rationale                            |
| ----------------- | --------------------------- | ------------------------------------ |
| npm audit ENOLOCK | âœ… Regenerate lockfile first | Determinism + accurate audit results |
| Playwright trace  | âœ… `retain-on-failure`       | Guarantees actionable CI artifacts   |
| Promote Best UI   | âœ… Option A only             | Clean UX, minimal scope, high signal |

---

If you want, I can now:

* Rewrite this into a **single Cursor execution checklist**, or
* Generate **exact code patches** (Playwright config diff, npm overrides, UI button wiring), or
* Estimate **audit score delta** from M20 â†’ M21 based on these changes.
